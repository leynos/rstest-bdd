# ExecPlan 9.4.1: design fixture injection for framework harnesses

This ExecPlan (execution plan) is a living document. The sections
`Constraints`, `Tolerances`, `Risks`, `Progress`, `Surprises & Discoveries`,
`Decision Log`, and `Outcomes & Retrospective` must be kept up to date as work
proceeds.

Status: DRAFT

`PLANS.md` is not present in this repository at the time of writing, so this
ExecPlan is the governing plan for roadmap item 9.4.1.

## Purpose / big picture

Roadmap item 9.4.1 requires an architectural decision and delivery plan for
framework fixture injection at the harness boundary. Today,
`HarnessAdapter::run` receives a `ScenarioRunRequest<'_, T>` that only wraps a
`FnOnce() -> T` runner. Because the closure is opaque, a harness cannot provide
framework resources to step execution (for example GPUI `TestAppContext` or
Bevy `World`) in a type-safe, reusable way.

After this work:

- A new ADR evaluates three approaches and selects one for both GPUI and Bevy:
  thread-local convention, associated `Context` type on `HarnessAdapter`, or a
  `StepContext` extension trait.
- The selected mechanism is reflected in `rstest-bdd-harness` trait and runner
  types, or is explicitly documented as a stable convention if no trait change
  is selected.
- Unit tests and behavioural tests validate the mechanism and regression-proof
  the chosen API.
- `docs/rstest-bdd-design.md` records the decision and final architecture.
- `docs/users-guide.md` documents user-facing usage for harness authors.
- `docs/roadmap.md` marks 9.4.1 done once all gates pass.

Success is observable when a harness can supply framework fixture state into
scenario/step execution under the selected design, with green quality gates:
`make check-fmt`, `make lint`, and `make test`.

## Constraints

- Implement roadmap item 9.4.1 only. Do not implement full GPUI adapter work
  from 9.4.2 to 9.4.4 in this change.
- Keep ADR-005 intent intact: framework specifics stay in opt-in harness
  crates, not in core `rstest-bdd` runtime or macro crates.
- Evaluate and document all three required options in the ADR before selecting
  one.
- Ensure selected approach explicitly supports both GPUI-style fixture access
  (`TestAppContext`) and Bevy-style fixture access (`World`).
- Include both unit and behavioural tests for the delivered mechanism.
- Update `docs/rstest-bdd-design.md` with the final decision and semantics.
- Update `docs/users-guide.md` with usage guidance and migration notes.
- Mark roadmap entry 9.4.1 done only after all required gates pass.
- Required gates before completion: `make check-fmt`, `make lint`, and
  `make test`.
- Run commands with `set -o pipefail` and `tee` so failures are not hidden.

## Tolerances (exception triggers)

- Scope: if delivery needs more than 16 files or 900 net lines, stop and
  escalate.
- Interface: if the selected approach requires changing macro argument syntax
  (`#[scenario(...)]` / `scenarios!(...)`), stop and escalate.
- Compatibility: if backward compatibility for `StdHarness` default usage
  cannot be preserved with a migration path, stop and escalate.
- Dependencies: if new external dependencies are required in core crates, stop
  and escalate.
- Iterations: if the same gate (`check-fmt`, `lint`, or `test`) fails three
  times after fixes, stop and escalate with logs.
- Ambiguity: if roadmap sequencing conflicts with existing ADR numbering or
  active ADR definitions, stop and document resolution options.

## Risks

- Risk: changing `HarnessAdapter` and `ScenarioRunRequest` generics could ripple
  through macros, harness crates, and tests.
  Severity: high.
  Likelihood: medium.
  Mitigation: stage the change with compile-first checkpoints and focused
  migration commits.

- Risk: thread-local convention can hide coupling and make test ordering or
  nested harness behaviour fragile.
  Severity: medium.
  Likelihood: medium.
  Mitigation: capture explicit trade-offs in ADR and reject if deterministic
  behavioural tests cannot prove correctness.

- Risk: a `StepContext` extension trait may over-couple harness internals to
  runtime context layout.
  Severity: medium.
  Likelihood: medium.
  Mitigation: evaluate trait ownership, object safety, and long-term evolution
  costs in ADR option analysis.

- Risk: roadmap text references "ADR-006" for context injection, but
  `docs/adr-006-fallible-scenario-functions.md` already exists.
  Severity: medium.
  Likelihood: high.
  Mitigation: assign the next available ADR number and update references where
  needed so numbering is unambiguous.

- Risk: documentation drift between roadmap, design doc, users guide, and ADR.
  Severity: medium.
  Likelihood: medium.
  Mitigation: update all docs in one stage and verify cross-links in review.

## Progress

- [x] (2026-02-26) Reviewed roadmap item 9.4.1 and current harness architecture
      (`HarnessAdapter`, `ScenarioRunRequest`, macro harness runtime path).
- [x] (2026-02-26) Reviewed ADR-005 and current design/user docs for harness
      adapters and fixture injection semantics.
- [x] (2026-02-26) Drafted this ExecPlan.
- [ ] Stage A: baseline and ADR framing.
- [ ] Stage B: prototype and evaluate the three injection approaches.
- [ ] Stage C: implement selected mechanism in harness core types.
- [ ] Stage D: adapt macro/runtime integration and harness plugin crates.
- [ ] Stage E: add unit and behavioural validation.
- [ ] Stage F: update ADR/design doc/users guide and mark roadmap item done.
- [ ] Stage G: run quality gates and capture logs.

## Surprises & Discoveries

- Observation: roadmap phase 9.5.1 still names the context-injection ADR as
  "ADR-006", but ADR-006 is already allocated to fallible scenario functions.
  Evidence: `docs/roadmap.md` and `docs/adr-006-fallible-scenario-functions.md`.
  Impact: this plan must allocate a non-conflicting ADR number for fixture
  injection and normalize references.

- Observation: macro harness delegation currently builds `StepContext` inside an
  opaque runner closure (`runtime/harness.rs`), which prevents harness-driven
  fixture injection.
  Evidence: `crates/rstest-bdd-macros/src/codegen/scenario/runtime/harness.rs`.
  Impact: any selected mechanism must shift context handoff visibility to the
  harness boundary.

## Decision Log

- Decision: treat 9.4.1 as a design-plus-delivery milestone, not ADR-only.
  Rationale: finish line requires the chosen mechanism to be reflected in
  `HarnessAdapter` or documented convention, and user requirements include unit
  and behavioural validation.
  Date/Author: 2026-02-26 / Codex.

- Decision: include an explicit prototyping stage for all three options before
  selecting the final approach.
  Rationale: the task is architecture-sensitive and impacts multiple crates.
  Fast prototyping de-risks API lock-in.
  Date/Author: 2026-02-26 / Codex.

## Outcomes & Retrospective

Planned outcomes for completion:

- ADR merged in-repo with explicit option evaluation, decision rationale,
  migration story, and GPUI/Bevy fitness analysis.
- Chosen fixture injection mechanism implemented (or convention codified) with
  tests proving behaviour.
- Docs (`rstest-bdd-design.md`, `users-guide.md`, `roadmap.md`) aligned with
  final state.
- Required gates (`check-fmt`, `lint`, `test`) pass with archived logs.

Retrospective notes will be completed after implementation.

## Context and orientation

Primary code and docs to touch:

- `crates/rstest-bdd-harness/src/adapter.rs`
  Current `HarnessAdapter::run<T>(&self, ScenarioRunRequest<'_, T>) -> T`.
- `crates/rstest-bdd-harness/src/runner.rs`
  Current `ScenarioRunner<'a, T>` and `ScenarioRunRequest<'a, T>` carry only
  metadata and an opaque closure.
- `crates/rstest-bdd-harness/src/std_harness.rs`
  Baseline implementation and unit tests.
- `crates/rstest-bdd-harness-tokio/src/tokio_harness.rs`
  Existing adapter implementation that will need migration if trait changes.
- `crates/rstest-bdd-macros/src/codegen/scenario/runtime/harness.rs`
  Harness delegation path where scenario context is currently built inside the
  closure.
- `crates/rstest-bdd-harness/tests/harness_behaviour.rs`
  Baseline behavioural tests for standard harness semantics.
- `crates/rstest-bdd-harness-tokio/tests/harness_behaviour.rs`
  Behavioural parity reference for plugin harnesses.
- `docs/adr-005-harness-adapter-crates-for-framework-specific-test-integration.md`
  Existing harness architecture ADR.
- `docs/rstest-bdd-design.md`
  Architecture narrative; section 2.7 documents harness adapters.
- `docs/users-guide.md`
  User-facing harness API section and custom harness examples.
- `docs/roadmap.md`
  Item tracking for 9.4.1.

Reference documents reviewed while planning:

- `docs/rstest-bdd-design.md`
- `docs/rstest-bdd-language-server-design.md`
- `docs/rust-testing-with-rstest-fixtures.md`
- `docs/rust-doctest-dry-guide.md`
- `docs/complexity-antipatterns-and-refactoring-strategies.md`
- `docs/gherkin-syntax.md`

## Plan of work

### Stage A: baseline and ADR framing

Goal: define objective decision criteria and capture current limitations before
editing APIs.

Implementation details:

- Run targeted baseline tests for harness crates and scenario macro integration.
- Document current execution flow from macro-generated runner to
  `HarnessAdapter::run` and where fixture injection is blocked.
- Draft ADR structure with sections for context, drivers, options, selected
  approach, migration, and consequences.

Go/no-go validation:

- Baseline test state is known.
- ADR scope and acceptance criteria are explicit and agreed in text.

### Stage B: prototype and evaluate three approaches

Goal: evaluate feasibility and trade-offs with evidence, not guesswork.

Implementation details:

1. Thread-local convention prototype.
   Exercise harness-provided context entering/leaving around `request.run()`.
2. Associated `Context` type on `HarnessAdapter` prototype.
   Model typed context propagation through request/runner APIs.
3. `StepContext` extension trait prototype.
   Model extending runtime context with harness-defined extraction points.

Each prototype must assess:

- Type safety for GPUI and Bevy.
- Macro/codegen impact.
- Backward-compatibility cost for `StdHarness` and `TokioHarness`.
- Testability with behavioural tests.

Go/no-go validation:

- ADR contains evidence-backed comparison and explicit rejection reasons for
  non-selected options.

### Stage C: implement selected mechanism in harness core

Goal: make the chosen approach real in the harness core surface.

Implementation details (if associated `Context` is selected):

- Update `HarnessAdapter` trait and runner/request types with context typing.
- Preserve `StdHarness` ergonomics with `Context = ()` defaults.
- Keep APIs explicit and minimal to avoid hidden coupling.

Implementation details (if convention-based path is selected):

- Encode convention in stable, documented helper APIs with guardrails.
- Add lint/test coverage proving convention correctness and isolation.

Go/no-go validation:

- `rstest-bdd-harness` compiles with updated tests.
- Selected mechanism is represented in code or formal convention API.

### Stage D: macro/runtime and plugin migration

Goal: thread the selected mechanism through generation and plugin adapters.

Implementation details:

- Update macro harness runtime assembly to hand context through the harness
  boundary instead of trapping it in an opaque closure.
- Migrate `rstest-bdd-harness-tokio` to the new interface.
- Add a small test-only probe harness to model GPUI/Bevy-style context
  injection without adding heavy framework dependencies.

Go/no-go validation:

- Macro-generated harness path compiles and executes with migrated API.
- Plugin harness tests pass with no regressions in existing behaviour.

### Stage E: unit and behavioural validation

Goal: prove the mechanism works and remains stable.

Implementation details:

- Unit tests for new trait/request/context plumbing in `rstest-bdd-harness`.
- Behavioural tests demonstrating harness-provided fixture availability at step
  execution time.
- Behavioural parity checks for panic propagation, metadata handling, and
  context lifecycle boundaries.
- Add compile-time or integration coverage where macro expansion contracts
  changed.

Go/no-go validation:

- New tests fail before implementation and pass after.
- Existing harness and macro tests remain green.

### Stage F: documentation and roadmap closure

Goal: align architecture and user-facing docs with final behaviour.

Implementation details:

- Add new ADR file with selected approach and migration guidance.
- Update `docs/rstest-bdd-design.md` section 2.7 and implementation status.
- Update `docs/users-guide.md` harness chapter with usage examples.
- Mark roadmap item 9.4.1 as done only after all gates pass.

Go/no-go validation:

- Documentation and code semantics match exactly.
- Roadmap state reflects delivered implementation.

### Stage G: quality gates

Goal: verify repository health before completion.

Implementation details:

- Run the required quality gates with `set -o pipefail` and `tee` logs.
- Review log tails to confirm success and no hidden failures.

Go/no-go validation:

- `make check-fmt`, `make lint`, and `make test` all succeed.

## Concrete steps

1. Baseline and discovery (repo root):

   ```bash
   set -o pipefail
   cargo test -p rstest-bdd-harness --test harness_behaviour 2>&1 | tee /tmp/9-4-1-baseline-harness.log
   cargo test -p rstest-bdd-harness-tokio --test harness_behaviour 2>&1 | tee /tmp/9-4-1-baseline-tokio.log
   ```

   Expected signal:

   ```plaintext
   ... test result: ok. <N> passed; 0 failed ...
   ```

2. Implement chosen mechanism and migrate affected crates in small commits.

3. Validate focused suites while iterating:

   ```bash
   set -o pipefail
   cargo test -p rstest-bdd-harness 2>&1 | tee /tmp/9-4-1-harness-tests.log
   cargo test -p rstest-bdd-harness-tokio 2>&1 | tee /tmp/9-4-1-tokio-tests.log
   cargo test -p rstest-bdd --test trybuild_macros 2>&1 | tee /tmp/9-4-1-trybuild.log
   ```

4. Run full required gates before completion:

   ```bash
   set -o pipefail
   make check-fmt 2>&1 | tee /tmp/9-4-1-check-fmt.log
   make lint 2>&1 | tee /tmp/9-4-1-lint.log
   make test 2>&1 | tee /tmp/9-4-1-test.log
   ```

5. Update docs and roadmap, then re-run any impacted checks as needed.

## Validation and acceptance

Acceptance criteria:

- ADR documents all three options, selects one, and justifies GPUI+Bevy fit.
- `HarnessAdapter`/runner interfaces (or documented convention) support harness
  fixture injection at step-execution boundary.
- Unit tests cover API semantics and invariants.
- Behavioural tests cover injected-context visibility plus existing harness
  invariants (runner execution, metadata, panic propagation).
- `docs/rstest-bdd-design.md` and `docs/users-guide.md` reflect the delivered
  behaviour.
- `docs/roadmap.md` marks 9.4.1 done.
- `make check-fmt`, `make lint`, and `make test` pass.

## Idempotence and recovery

- All steps are re-runnable.
- If a migration step fails mid-way, revert only the partial local edits for
  that step, keep successful prior stages, and re-run focused tests.
- Keep log files in `/tmp/` for each gate and rerun only failed commands after
  fixes.

## Artifacts and notes

Expected validation logs:

```plaintext
/tmp/9-4-1-baseline-harness.log
/tmp/9-4-1-baseline-tokio.log
/tmp/9-4-1-harness-tests.log
/tmp/9-4-1-tokio-tests.log
/tmp/9-4-1-trybuild.log
/tmp/9-4-1-check-fmt.log
/tmp/9-4-1-lint.log
/tmp/9-4-1-test.log
```

Primary implementation artifact set:

- ADR file for fixture injection mechanism (new).
- Harness API and macro runtime updates.
- Unit and behavioural tests.
- Design doc, users guide, and roadmap updates.

## Interfaces and dependencies

Candidate end-state interface if associated context is selected:

```rust
pub trait HarnessAdapter {
    type Context: 'static;

    fn run<T>(&self, request: ScenarioRunRequest<'_, Self::Context, T>) -> T;
}
```

Related request/runner threading (illustrative):

```rust
pub struct ScenarioRunRequest<'a, C, T> {
    metadata: ScenarioMetadata,
    context: C,
    runner: ScenarioRunner<'a, C, T>,
}
```

If an alternative is selected, this section must be updated to the precise,
implemented API and migration contract.

## Revision note

Initial draft created on 2026-02-26 for roadmap item 9.4.1.
